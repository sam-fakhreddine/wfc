<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DATUM Query Execution Flow</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=Fira+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #1E40AF;
    --secondary: #3B82F6;
    --cta: #F59E0B;
    --bg: #F8FAFC;
    --text: #1E3A8A;
    --border: #DBEAFE;
    --card-bg: #FFFFFF;
    --card-shadow: rgba(30, 64, 175, 0.08);
    --grid-color: rgba(30, 58, 90, 0.06);
    --subtitle-color: #64748B;
    --controls-bg: rgba(255, 255, 255, 0.95);
    --controls-border: #DBEAFE;
    --controls-hover: #EFF6FF;
    --controls-text: #1E40AF;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --primary: #3B82F6;
      --secondary: #60A5FA;
      --cta: #F59E0B;
      --bg: #0F172A;
      --text: #DBEAFE;
      --border: #1E3A5A;
      --card-bg: #1E293B;
      --card-shadow: rgba(0, 0, 0, 0.3);
      --grid-color: rgba(59, 130, 246, 0.07);
      --subtitle-color: #94A3B8;
      --controls-bg: rgba(30, 41, 59, 0.95);
      --controls-border: #334155;
      --controls-hover: #334155;
      --controls-text: #93C5FD;
    }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(24px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-delay: 0ms !important;
      transition-duration: 0.01ms !important;
    }
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Fira Sans', sans-serif;
    background-color: var(--bg);
    color: var(--text);
    min-height: 100vh;
    background-image:
      linear-gradient(var(--grid-color) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
    background-size: 40px 40px;
    padding: 2rem;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  header {
    text-align: center;
    margin-bottom: 2rem;
    animation: fadeUp 0.6s ease-out both;
  }

  header h1 {
    font-family: 'Fira Code', monospace;
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.5rem;
    letter-spacing: -0.02em;
  }

  header p {
    font-size: 1rem;
    color: var(--subtitle-color);
  }

  .diagram-wrapper {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px var(--card-shadow);
    position: relative;
    overflow: hidden;
    animation: fadeUp 0.6s ease-out 0.15s both;
  }

  .zoom-controls {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.25rem;
    z-index: 10;
    animation: fadeUp 0.6s ease-out 0.3s both;
  }

  .zoom-btn {
    width: 36px;
    height: 36px;
    border: 1px solid var(--controls-border);
    background: var(--controls-bg);
    color: var(--controls-text);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Fira Code', monospace;
    font-size: 1rem;
    font-weight: 600;
    transition: background 0.15s ease;
  }

  .zoom-btn:hover {
    background: var(--controls-hover);
  }

  .zoom-btn.reset {
    font-size: 0.65rem;
    width: auto;
    padding: 0 10px;
  }

  .mermaid-container {
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 600px;
  }

  .mermaid-container .mermaid {
    transition: transform 0.2s ease;
    transform-origin: top center;
  }

  .mermaid svg {
    max-width: none !important;
  }

  .info-bar {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    animation: fadeUp 0.6s ease-out 0.45s both;
  }

  .info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Fira Code', monospace;
    font-size: 0.75rem;
    color: var(--subtitle-color);
  }

  .info-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>DATUM Query Execution Flow</h1>
    <p>Sequence diagram showing query lifecycle from client request to response</p>
  </header>

  <div class="diagram-wrapper">
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoom(0.1)" title="Zoom In">+</button>
      <button class="zoom-btn" onclick="zoom(-0.1)" title="Zoom Out">&minus;</button>
      <button class="zoom-btn reset" onclick="resetZoom()" title="Reset Zoom">Reset</button>
    </div>
    <div class="mermaid-container" id="mermaid-container">
      <pre class="mermaid" id="mermaid-diagram">
sequenceDiagram
    participant Client
    participant GW as API Gateway
    participant Auth as Auth Service
    participant QE as Query Engine
    participant Opt as Optimizer
    participant Cat as Catalog
    participant Cache
    participant Exec as Executor
    participant Store as Storage

    Client->>GW: POST /query {sql}
    activate GW
    GW->>Auth: Validate token
    activate Auth
    Auth-->>GW: Token valid
    deactivate Auth
    GW->>QE: Submit query
    activate QE
    QE->>QE: Parse SQL
    QE->>Opt: Generate plan
    activate Opt
    Opt->>Cat: Fetch table metadata
    activate Cat
    Cat-->>Opt: Schema + stats
    deactivate Cat
    Opt-->>QE: Optimized plan
    deactivate Opt
    QE->>Cache: Check result cache
    activate Cache
    alt Cache Hit
        Cache-->>QE: Cached result
        deactivate Cache
    else Cache Miss
        deactivate Cache
        QE->>Exec: Execute plan
        activate Exec
        Exec->>Store: Read partitions
        activate Store
        Store-->>Exec: Data blocks
        deactivate Store
        Exec-->>QE: Result set
        deactivate Exec
        QE->>Cache: Store result
    end
    QE-->>GW: Results
    deactivate QE
    GW-->>Client: 200 OK {data}
    deactivate GW
      </pre>
    </div>
  </div>

  <div class="info-bar">
    <div class="info-item">
      <div class="info-dot" style="background: #3B82F6;"></div>
      Synchronous Request
    </div>
    <div class="info-item">
      <div class="info-dot" style="background: #10B981;"></div>
      Cache Path (fast)
    </div>
    <div class="info-item">
      <div class="info-dot" style="background: #F59E0B;"></div>
      Execution Path (compute)
    </div>
    <div class="info-item">
      <div class="info-dot" style="background: #8B5CF6;"></div>
      Metadata Lookup
    </div>
  </div>
</div>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  mermaid.initialize({
    startOnLoad: true,
    securityLevel: 'loose',
    theme: 'base',
    themeVariables: isDark ? {
      actorBkg: '#1E3A5A',
      actorTextColor: '#DBEAFE',
      actorBorder: '#3B82F6',
      actorLineColor: '#60A5FA',
      signalColor: '#DBEAFE',
      signalTextColor: '#DBEAFE',
      labelBoxBkgColor: '#1E293B',
      labelBoxBorderColor: '#3B82F6',
      labelTextColor: '#DBEAFE',
      loopTextColor: '#FBBF24',
      activationBorderColor: '#60A5FA',
      activationBkgColor: '#1E3A5A',
      sequenceNumberColor: '#FFFFFF',
      noteBkgColor: '#1E3A5A',
      noteBorderColor: '#3B82F6',
      noteTextColor: '#DBEAFE',
      altSectionBkgColor: '#1E293B',
      fontSize: '14px',
      fontFamily: 'Fira Sans, sans-serif'
    } : {
      actorBkg: '#1E40AF',
      actorTextColor: '#FFFFFF',
      actorBorder: '#3B82F6',
      actorLineColor: '#3B82F6',
      signalColor: '#1E3A8A',
      signalTextColor: '#1E3A8A',
      labelBoxBkgColor: '#EFF6FF',
      labelBoxBorderColor: '#3B82F6',
      labelTextColor: '#1E40AF',
      loopTextColor: '#D97706',
      activationBorderColor: '#3B82F6',
      activationBkgColor: '#DBEAFE',
      sequenceNumberColor: '#FFFFFF',
      noteBkgColor: '#FEF3C7',
      noteBorderColor: '#F59E0B',
      noteTextColor: '#92400E',
      altSectionBkgColor: '#F0F9FF',
      fontSize: '14px',
      fontFamily: 'Fira Sans, sans-serif'
    }
  });
</script>

<script>
  let currentZoom = 1;
  const diagram = document.getElementById('mermaid-diagram');

  function zoom(delta) {
    currentZoom = Math.max(0.3, Math.min(3, currentZoom + delta));
    diagram.style.transform = 'scale(' + currentZoom + ')';
  }

  function resetZoom() {
    currentZoom = 1;
    diagram.style.transform = 'scale(1)';
  }
</script>
</body>
</html>