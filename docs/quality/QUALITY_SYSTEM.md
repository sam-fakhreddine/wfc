# WFC Quality System

**Universal quality gates for all languages using Trunk.io**

## Overview

WFC implements a **comprehensive quality system** that enforces code standards before multi-agent review:

1. **Universal Quality Checker** - Trunk.io for ALL languages
2. **Language-Specific Fallbacks** - Python (black/ruff), JS/TS (prettier/eslint), etc.
3. **Project Initialization** - `/wfc-init` auto-detects and configures
4. **Pre-Review Gate** - Enforced by `wfc-implement` before `wfc-review`

## The WFC Way: Trunk.io

**Why Trunk?**

- âœ… **Universal**: One tool for Python, JS, TS, Go, Rust, Java, Ruby, C#, YAML, JSON, Markdown
- âœ… **100+ tools integrated**: ruff, eslint, prettier, clippy, gofmt, rubocop, etc.
- âœ… **Auto-detection**: Recognizes file types and runs appropriate tools
- âœ… **Fast**: Cached results, parallel execution
- âœ… **One command**: `trunk check` for everything

**Instead of**:

```bash
black src/
ruff check src/
prettier --write frontend/
eslint frontend/
gofmt -w services/
golangci-lint run services/
```

**Do**:

```bash
trunk check          # All languages, all tools
trunk check --fix    # Auto-fix everything
```

## Installation

### Trunk (Recommended)

```bash
# macOS/Linux
curl https://get.trunk.io -fsSL | bash

# Or Homebrew
brew install trunk-io

# Or npm
npm install -g @trunkio/launcher

# Or direct download
# https://trunk.io/docs/install
```

### Initialize in Project

```bash
# WFC auto-initialization
/wfc-init

# Or manually
trunk init

# Verify
trunk check
```

## Usage

### Command Line

```bash
# Check all files
make quality-check

# Check with auto-fix
make quality-check-fix

# Check specific files
trunk check src/module.py frontend/app.tsx

# Watch mode (continuous checking)
trunk check --watch
```

### In wfc-implement Workflow

**Automatic enforcement**:

```
Agent implements code
    â†“
Agent runs tests (TDD)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QUALITY GATE (Trunk)   â”‚  â† Automatic
â”‚  âœ… Format check        â”‚
â”‚  âœ… Lint check          â”‚
â”‚  âœ… Security check      â”‚
â”‚  âœ… Tests               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (only if all pass)
wfc-review (Multi-agent consensus)
    â†“
Merge to main
```

## Supported Languages

| Language | Formatter | Linter | Security | Tests |
|----------|-----------|--------|----------|-------|
| **Python** | black | ruff | bandit | pytest |
| **JavaScript** | prettier | eslint | semgrep | jest |
| **TypeScript** | prettier | eslint+TS | semgrep | jest |
| **Go** | gofmt | golangci-lint | gosec | go test |
| **Rust** | rustfmt | clippy | cargo-audit | cargo test |
| **Java** | google-java-format | checkstyle | spotbugs | junit |
| **Ruby** | rubocop | rubocop | brakeman | rspec |
| **C#** | dotnet format | dotnet analyze | security-scan | dotnet test |
| **Shell** | shfmt | shellcheck | - | bats |
| **YAML** | prettier | yamllint | - | - |
| **JSON** | prettier | jsonlint | - | - |
| **Markdown** | prettier | markdownlint | - | - |

## Configuration

### .trunk/trunk.yaml (Auto-generated by trunk init)

```yaml
version: 0.1
cli:
  version: 1.22.0

plugins:
  sources:
    - id: trunk
      ref: v1.6.0
      uri: https://github.com/trunk-io/plugins

runtimes:
  enabled:
    - python@3.12.0
    - go@1.21.0
    - node@18.12.1
    - rust@1.75.0

lint:
  enabled:
    # Python
    - black@24.1.1
    - ruff@0.1.15
    - bandit@1.7.5
    - mypy@1.8.0

    # JavaScript/TypeScript
    - prettier@3.2.4
    - eslint@8.56.0
    - semgrep@1.50.0

    # Go
    - gofmt@1.21.0
    - golangci-lint@1.55.2
    - gosec@2.18.2

    # Rust
    - rustfmt@1.75.0
    - clippy@1.75.0

    # Universal
    - markdownlint@0.38.0
    - yamllint@1.33.0
    - shellcheck@0.9.0

  ignore:
    - linters: [ALL]
      paths:
        - .venv/**
        - node_modules/**
        - dist/**
        - build/**
```

### Customization

```yaml
# Custom rules
lint:
  definitions:
    - name: custom-rule
      commands:
        - name: lint
          run: my-custom-linter ${target}

  enabled:
    - custom-rule
```

## Integration with WFC

### wfc-init

Detects languages and sets up Trunk:

```bash
/wfc-init

ğŸ” Detecting languages...
  âœ… Python (42 files)
  âœ… TypeScript (18 files)
  âœ… Go (7 files)

ğŸ”§ Initializing Trunk...
  âœ… .trunk/trunk.yaml created
  âœ… Configured linters for all languages
  âœ… Added to Makefile

Run: make quality-check
```

### wfc-implement

Enforces quality gate before review:

```python
def agent_workflow(task):
    # 1-4. Understand, test, implement, refactor
    files = implement_task(task)

    # 5. Quality gate (Trunk)
    result = subprocess.run(["trunk", "check"] + files)

    if result.returncode != 0:
        print("âŒ Quality check failed")
        print("Fix with: trunk check --fix")
        return "BLOCKED"

    # 6. Send to review (only if passed)
    return send_to_review(files)
```

### wfc-review

Reviewers focus on high-level issues:

- âœ… Logic and algorithms
- âœ… Architecture and design
- âœ… Security vulnerabilities
- âœ… Performance implications

**NOT** on:

- âŒ Code formatting
- âŒ Unused imports
- âŒ Line length
- âŒ Style issues

*Because Trunk already caught those!*

## Makefile Integration

```makefile
# Universal quality check (Trunk)
quality-check:
 trunk check

# With auto-fix
quality-check-fix:
 trunk check --fix

# Watch mode
quality-check-watch:
 trunk check --watch

# Specific language (if Trunk not available)
quality-check-python:
 black --check wfc/
 ruff check wfc/
 pytest
```

## Pre-commit Integration

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/trunk-io/pre-commit
    rev: v1.6.0
    hooks:
      - id: trunk-check
        args: [--fix]
```

## CI/CD Integration

```yaml
# .github/workflows/quality.yml
name: Quality Check

on: [push, pull_request]

jobs:
  trunk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Trunk Check
        uses: trunk-io/trunk-action@v1
        with:
          check-mode: all
```

## ROI: Quality Gate vs No Gate

### Without Quality Gate

```
Cost per review cycle:
  5 personas Ã— 2000 tokens = 10,000 tokens

Issues found in review:
  - "Code not formatted" (5 comments)
  - "Unused import" (3 comments)
  - "Line too long" (8 comments)
  - "Missing type hint" (4 comments)

Agent fixes â†’ Re-review:
  Another 10,000 tokens

Total: 20,000 tokens, 2 cycles, reviewer frustration
```

### With Quality Gate (Trunk)

```
Quality gate (local, free):
  trunk check (< 1 second)

Finds and fixes:
  - Code formatting âœ…
  - Unused imports âœ…
  - Line length âœ…
  - Type hints âœ…

Review focuses on:
  - Logic errors
  - Security issues
  - Performance problems
  - Architecture decisions

Total: 10,000 tokens, 1 cycle, productive review
```

**Savings**: 50% tokens, 50% time, 100% better reviews

## Best Practices

1. **Install Trunk first**: `curl https://get.trunk.io -fsSL | bash`
2. **Initialize in project**: `/wfc-init` or `trunk init`
3. **Run before commit**: `make quality-check`
4. **Auto-fix when possible**: `trunk check --fix`
5. **Integrate in CI**: GitHub Actions with trunk-io/trunk-action
6. **Pre-commit hooks**: Catch issues before commit
7. **Watch mode for development**: `trunk check --watch`

## Fallback: Language-Specific Tools

If Trunk unavailable, WFC falls back to language-specific tools:

**Python**:

```bash
black --check wfc/
ruff check wfc/
pytest
```

**JavaScript/TypeScript**:

```bash
prettier --check src/
eslint src/
jest
```

**Go**:

```bash
gofmt -l .
golangci-lint run
go test ./...
```

See `wfc/scripts/quality_checker.py` for Python-specific checker.

## Philosophy

**WFC = World Fucking Class**:

- âœ… **UNIVERSAL**: One tool for all languages (Trunk)
- âœ… **ELEGANT**: Simple, fast, comprehensive
- âœ… **TOKEN-AWARE**: Fix locally (free) not in review (expensive)
- âœ… **QUALITY-FIRST**: Enforce standards automatically
- âœ… **REVIEW-FOCUSED**: Let reviewers focus on what matters

---

**This is World Fucking Class.** ğŸš€
