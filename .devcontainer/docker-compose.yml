# ═══════════════════════════════════════════════════════════════════════════════
# WFC DevContainer Docker Compose
#
# Full-featured secure development environment with WFC pre-installed
# Add project-specific services (postgres, redis, etc.) in your own docker-compose.override.yml
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ════════════════════════════════════════════════════════════════════════════
  # MAIN DEVCONTAINER SERVICE
  # ════════════════════════════════════════════════════════════════════════════
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: devcontainer
      args:
        USERNAME: wfc
        USER_UID: 1000
        USER_GID: 1000

    # Container name
    container_name: wfc-devcontainer

    # Volumes for workspace and SSH
    # NOTE: Project folder mounts are configured in docker-compose.override.yml
    #       (generated by setup.sh)
    volumes:
      # SSH agent socket for Git operations
      - ${SSH_AUTH_SOCK:-/tmp/.ssh-auth-sock}:/tmp/.ssh-auth-sock:ro

      # Docker socket for Docker-in-Docker
      - /var/run/docker.sock:/var/run/docker.sock:rw

      # Persistent home directory — survives rebuilds
      # Preserves: ~/.claude/, ~/.ssh/, ~/.config/gh/, ~/.cache/,
      #            ~/.zshrc, ~/.bashrc, Oh My Zsh, Starship, git config
      # Docker auto-populates from image on first mount
      - home-dir:/home/wfc

      # Workspace tmp directory (persistent across restarts)
      - workspace-tmp:/workspace/tmp

    # Environment variables
    environment:
      - SSH_AUTH_SOCK=/tmp/.ssh-auth-sock
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-WFC Dev}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-dev@wfc.local}
      - GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME:-WFC Dev}
      - GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL:-dev@wfc.local}

      # Python
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - UV_SYSTEM_PYTHON=1

      # Node.js
      - NODE_ENV=development

      # Firewall configuration
      - FIREWALL_MODE=${FIREWALL_MODE:-audit}

      # Claude Code with autonomous permissions
      - CLAUDE_DANGEROUSLY_DISABLE_SANDBOX=true
      - CLAUDE_AUTO_APPROVE_DANGEROUS_COMMANDS=true

      # PATH
      - PATH=/home/wfc/.npm-global/bin:/home/wfc/.local/bin:${PATH}

      # Anthropic API token (optional — can use Claude account instead of API key)
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN:-}

    # Network for service communication
    networks:
      - wfc-dev

    # Full container capabilities for autonomous development
    # Security boundary is the FIREWALL, not container restrictions
    cap_add:
      - SYS_PTRACE    # Debugging (gdb, strace)
      - NET_ADMIN     # Network configuration (firewall)
      - NET_RAW       # Raw socket access
      - SYS_ADMIN     # System administration
      - SYS_CHROOT    # chroot()
      - MKNOD         # Device node creation
      - SYS_MODULE    # Kernel module loading
      - SYS_RAWIO     # Raw I/O operations
      - SYS_RESOURCE  # Resource limits
      - SYS_TIME      # System clock
      - AUDIT_WRITE   # Audit logging
      - AUDIT_CONTROL # Audit control

    # Security options
    # seccomp:unconfined allows all syscalls (needed for autonomous development)
    # Security boundary is the FIREWALL, not syscall filtering
    security_opt:
      - seccomp:unconfined

    # Keep container running
    tty: true
    stdin_open: true

    # Command override - zsh with Oh My Zsh + Starship
    command: /bin/zsh

    # Health check - verify essential tools are available
    healthcheck:
      test: ["CMD", "/home/wfc/.healthcheck.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

# ═══════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  wfc-dev:
    name: wfc-dev-network
    driver: bridge

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  # Entire home directory — all user config survives rebuilds
  # Includes: ~/.claude/, ~/.ssh/, ~/.config/gh/, ~/.cache/uv, ~/.npm,
  #           ~/.zshrc, ~/.bashrc, .oh-my-zsh, .gitconfig, etc.
  home-dir:
    name: wfc-dev-home
  # Workspace tmp directory (persistent)
  workspace-tmp:
    name: wfc-dev-workspace-tmp
