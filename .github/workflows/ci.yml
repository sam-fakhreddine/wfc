name: CI

"on":
  push:
    branches: [main, develop, 'rc/**']
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          uv pip install --system black ruff mypy
          uv pip install --system pytest pytest-cov

      - name: Run black
        run: uv run black --check --diff wfc/

      - name: Run ruff
        run: uv run ruff check wfc/

      - name: Run mypy
        run: uv run mypy wfc/ --ignore-missing-imports || true

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install bash 4+ on macOS
        if: runner.os == 'macOS'
        run: brew install bash

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Install WFC skills
        run: |
          chmod +x install.sh
          ./install.sh --ci

      - name: Run tests
        run: |
          uv run pytest tests/ -v --cov=wfc --cov-report=xml --ignore=tests/test_installer_docker.py

      - name: Upload coverage
        if: matrix.python-version == '3.12' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-wfc

  validate-reviewers:
    name: Validate Reviewer Library
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate reviewer PROMPT.md files
        run: |
          python3 << 'EOF'
          from pathlib import Path

          reviewers_dir = Path('wfc/references/reviewers')
          expected = ['security', 'correctness', 'performance', 'maintainability', 'reliability']
          errors = []

          for name in expected:
              prompt = reviewers_dir / name / 'PROMPT.md'
              if not prompt.exists():
                  errors.append(f"Missing: {prompt}")
              elif len(prompt.read_text()) < 100:
                  errors.append(f"Too short: {prompt}")

          if errors:
              print("❌ Reviewer validation errors:")
              for e in errors:
                  print(f"  - {e}")
              exit(1)
          else:
              print(f"✅ All {len(expected)} reviewer PROMPT.md files validated")
          EOF

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, test, validate-reviewers]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install build tools
        run: |
          uv pip install --system build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: python -m twine check dist/*

      - name: Test installation
        run: |
          uv pip install --system dist/*.whl
          uv run python -c "import sys; print('✅ Package installs successfully')"

  install-test:
    name: Test Install Script
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install bash 4+ on macOS
        if: runner.os == 'macOS'
        run: brew install bash

      - name: Create mock Claude directory
        run: mkdir -p ~/.claude/skills

      - name: Test install script
        run: |
          chmod +x install.sh
          printf '2\n1\n' | ./install.sh

      - name: Verify installation
        run: |
          # Check framework installed
          [ -d ~/.claude/skills/wfc ] || (echo "❌ Framework not installed" && exit 1)

          # Check skills flattened
          skill_count=$(ls -d ~/.claude/skills/wfc-* 2>/dev/null | wc -l)
          if [ "$skill_count" -lt 10 ]; then
              echo "❌ Skills not properly flattened (found $skill_count, expected ≥10)"
              exit 1
          fi

          # Check 5 fixed reviewers installed
          reviewer_count=$(ls -d ~/.claude/skills/wfc/references/reviewers/*/PROMPT.md 2>/dev/null | wc -l)
          if [ "$reviewer_count" -lt 5 ]; then
              echo "❌ Reviewer library incomplete (found $reviewer_count, expected 5)"
              exit 1
          fi

          echo "✅ Installation verified: $skill_count skills, $reviewer_count reviewers"
