name: Validate WFC Skills

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -e ".[dev,tokens]"

    - name: Install WFC skills
      run: |
        mkdir -p ~/.claude/skills
        chmod +x install.sh
        ./install.sh <<< 'y'

    - name: Run tests
      run: |
        source .venv/bin/activate
        pytest -v

    - name: Check formatting
      run: |
        source .venv/bin/activate
        black --check wfc/

    - name: Run linter
      run: |
        source .venv/bin/activate
        ruff check wfc/

  validate-skills:
    name: Validate Agent Skills Compliance
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install WFC skills
      run: |
        mkdir -p ~/.claude/skills
        chmod +x install.sh
        ./install.sh <<< 'y'

    - name: Install validation dependencies
      run: pip install pyyaml

    - name: Validate all WFC skills
      run: |
        python3 << 'PYEOF'
        import yaml
        import os
        import sys

        skills_dir = os.path.expanduser("~/.claude/skills")
        failed = False

        for entry in sorted(os.listdir(skills_dir)):
            if not entry.startswith("wfc-"):
                continue
            skill_dir = os.path.join(skills_dir, entry)
            if not os.path.isdir(skill_dir):
                continue

            skill_md = os.path.join(skill_dir, "SKILL.md")
            if not os.path.exists(skill_md):
                print(f"❌ {entry}: missing SKILL.md")
                failed = True
                continue

            with open(skill_md) as f:
                content = f.read()

            # Check YAML frontmatter
            if not content.startswith("---"):
                print(f"❌ {entry}: SKILL.md missing YAML frontmatter")
                failed = True
                continue

            parts = content.split("---", 2)
            if len(parts) < 3:
                print(f"❌ {entry}: SKILL.md has malformed frontmatter")
                failed = True
                continue

            try:
                meta = yaml.safe_load(parts[1])
            except yaml.YAMLError as e:
                print(f"❌ {entry}: invalid YAML frontmatter: {e}")
                failed = True
                continue

            # Validate required fields per Agent Skills spec
            if not meta or not isinstance(meta, dict):
                print(f"❌ {entry}: empty frontmatter")
                failed = True
                continue

            missing = [f for f in ["name", "description"] if f not in meta]
            if missing:
                print(f"❌ {entry}: missing required fields: {missing}")
                failed = True
                continue

            print(f"✅ {entry}: valid (name={meta['name']})")

        if failed:
            print("\n❌ Some skills failed validation")
            sys.exit(1)
        else:
            print("\n✅ All WFC skills validated")
        PYEOF

  benchmark:
    name: Token Usage Benchmark
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -e ".[tokens]"

    - name: Run benchmark
      run: |
        source .venv/bin/activate
        python scripts/benchmark_tokens.py --compare
